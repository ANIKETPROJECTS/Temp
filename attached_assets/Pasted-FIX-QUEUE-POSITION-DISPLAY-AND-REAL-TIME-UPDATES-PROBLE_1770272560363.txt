FIX QUEUE POSITION DISPLAY AND REAL-TIME UPDATES

PROBLEMS TO FIX:

1. Customer sees wrong queue number (#41) instead of actual position (#1)
2. Bottom-right notification shows wrong position (#43) instead of actual position
3. When customer ahead leaves queue, remaining customers don't see updated position
4. Need real-time queue position updates for all customers

REQUIREMENTS:

ISSUE 1: FIX QUEUE POSITION CALCULATION
--------------------------------------

PROBLEM: Customer is showing as #41 or #43 but actual position should be #1

ROOT CAUSE: Using booking ID or total booking count instead of calculating actual queue position

FIX NEEDED:

BACKEND - Update the customer queue status endpoint:
```javascript
// Route: GET /api/bookings/status/:id (or similar route that sends queue info to customer)

router.get('/bookings/status/:id', async (req, res) => {
  try {
    const bookingId = req.params.id;
    const currentBooking = await Booking.findById(bookingId);
    
    if (!currentBooking) {
      return res.status(404).json({ error: 'Booking not found' });
    }
    
    // CRITICAL FIX: Calculate ACTUAL queue position
    // Count how many WAITING bookings were created BEFORE this one
    const position = await Booking.countDocuments({
      status: 'WAITING',
      createdAt: { $lt: currentBooking.createdAt }
    });
    
    const actualQueuePosition = position + 1;  // +1 because counting starts at 0
    
    // Get total people waiting
    const totalWaiting = await Booking.countDocuments({
      status: 'WAITING'
    });
    
    res.json({
      booking: currentBooking,
      queuePosition: actualQueuePosition,  // This should be #1, not #41
      totalWaiting: totalWaiting,
      status: currentBooking.status
    });
    
  } catch (error) {
    res.status(500).json({ error: 'Failed to fetch booking status' });
  }
});
```

FRONTEND - Update customer pages to use queuePosition:

IMAGE 1 (You're Confirmed page):
```javascript
// WRONG - Don't use booking ID
<div>#{booking._id}</div>

// CORRECT - Use calculated queue position
<div>#{queuePosition}</div>
```

IMAGE 2 (Queued page):
```javascript
// Main queue number display
<h1>#{queuePosition}</h1>

// Bottom notification
<div>Welcome to the queue! You are #{queuePosition} in line.</div>
```

IMAGE 3 (Table is Ready page):
```javascript
// This page doesn't need queue position since table is ready
// Keep as is
```

ISSUE 2: REAL-TIME QUEUE POSITION UPDATES
-----------------------------------------

REQUIREMENT: When customer #1 leaves queue, customer #2 should automatically see they are now #1

IMPLEMENTATION OPTIONS:

OPTION A - POLLING (Simpler, recommended):

FRONTEND - Customer pages (Images 1 & 2):
```javascript
import { useState, useEffect } from 'react';

function CustomerQueuePage({ bookingId }) {
  const [queuePosition, setQueuePosition] = useState(null);
  const [previousPosition, setPreviousPosition] = useState(null);
  const [showPromotion, setShowPromotion] = useState(false);
  
  // Poll for queue updates every 5 seconds
  useEffect(() => {
    const fetchQueuePosition = async () => {
      try {
        const response = await fetch(`/api/bookings/status/${bookingId}`);
        const data = await response.json();
        
        // Check if position improved
        if (previousPosition && data.queuePosition < previousPosition) {
          // Customer moved up in queue!
          setShowPromotion(true);
          setTimeout(() => setShowPromotion(false), 5000); // Hide after 5 seconds
        }
        
        setPreviousPosition(queuePosition);
        setQueuePosition(data.queuePosition);
        
      } catch (error) {
        console.error('Error fetching queue status:', error);
      }
    };
    
    // Initial fetch
    fetchQueuePosition();
    
    // Poll every 5 seconds
    const interval = setInterval(fetchQueuePosition, 5000);
    
    // Cleanup on unmount
    return () => clearInterval(interval);
  }, [bookingId, queuePosition, previousPosition]);
  
  return (
    <div>
      {/* Queue position display */}
      <h1>#{queuePosition || '...'}</h1>
      
      {/* Promotion notification */}
      {showPromotion && (
        <div className="promotion-alert">
          ðŸŽ‰ You moved up! You are now #{queuePosition} in queue!
        </div>
      )}
      
      {/* Rest of the page */}
    </div>
  );
}
```

ADD PROMOTION NOTIFICATION CSS:
```css
.promotion-alert {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: #4CAF50;
  color: white;
  padding: 15px 30px;
  border-radius: 8px;
  font-weight: bold;
  font-size: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  animation: slideDown 0.3s ease-out;
  z-index: 1000;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}
```

OPTION B - WEBSOCKETS (More advanced, real-time):

BACKEND - Setup Socket.io:
```javascript
const io = require('socket.io')(server);

// When booking status changes (leave, cancel, confirm)
io.emit('queueUpdated', {
  message: 'Queue positions have changed',
  timestamp: new Date()
});

// Example: When customer leaves queue
router.patch('/bookings/:id/leave', async (req, res) => {
  // ... existing leave logic ...
  
  // Emit socket event
  io.emit('queueUpdated', { 
    action: 'customer_left',
    timestamp: new Date() 
  });
  
  res.json({ success: true });
});
```

FRONTEND - Listen for updates:
```javascript
import io from 'socket.io-client';

useEffect(() => {
  const socket = io();
  
  socket.on('queueUpdated', () => {
    // Refresh queue position immediately
    fetchQueuePosition();
  });
  
  return () => socket.disconnect();
}, []);
```

ISSUE 3: ENSURE ALL CUSTOMER ACTIONS TRIGGER POSITION RECALCULATION
-------------------------------------------------------------------

Make sure these actions update queue positions for remaining customers:

1. When customer clicks "LEAVE QUEUE"
2. When customer clicks "Cancel Booking"
3. When admin confirms/completes booking
4. When admin cancels booking

ALL these actions should:
```javascript
// After updating booking status
await booking.save();

// Emit websocket event (if using Option B)
io.emit('queueUpdated', { action: 'position_change' });

// OR just rely on polling (if using Option A)
// Customers will see updated position within 5 seconds
```

COMPLETE FLOW EXAMPLE:

SCENARIO: 2 customers in queue
- Mansi is #1 (status: WAITING)
- Rohan is #2 (status: WAITING)

STEP 1: Mansi leaves queue
- Mansi clicks "LEAVE QUEUE" button
- Backend changes Mansi's status from WAITING to LEAVE
- Backend saves with updatedAt = now

STEP 2: Rohan's position updates
- Option A (Polling): Within 5 seconds, Rohan's page polls backend
- Option B (WebSocket): Immediately, Rohan's page receives queueUpdated event
- Backend recalculates: Rohan now has 0 bookings ahead â†’ position = 1
- Frontend shows: "ðŸŽ‰ You moved up! You are now #1 in queue!"

TESTING CHECKLIST:
-----------------
- [ ] Customer sees correct queue position (not booking ID)
- [ ] Bottom notification shows correct position
- [ ] When customer #1 leaves, customer #2 sees they are now #1
- [ ] Promotion notification appears when position improves
- [ ] Position updates automatically (every 5 seconds with polling)
- [ ] Multiple customers can see real-time position changes
- [ ] All customer actions (leave, cancel, confirm) trigger updates

IMPORTANT NOTES:
---------------
- âœ… Use createdAt for queue position calculation (who joined first)
- âœ… Use actualQueuePosition, NOT booking._id or total count
- âœ… Count only WAITING bookings ahead of current customer
- âœ… Update position automatically with polling or websockets
- âœ… Show promotion notification when customer moves up
- âœ… Keep all other functionality working

RECOMMENDED APPROACH:
--------------------
Start with Option A (Polling) - it's simpler and works well for most cases.
If you need instant updates, implement Option B (WebSockets) later.

For now, implement:
1. Fix queue position calculation (use countDocuments)
2. Add polling every 5 seconds to refresh position
3. Show promotion notification when position improves
4. Keep all existing features working